KoreanURLShortener.LinkModel=OBJECT({preset:()=>{return KoreanURLShortener.MODEL},params:()=>{let e={url:{notEmpty:!0,size:{max:2e3}},count:{notEmpty:!0,integer:!0}};return{name:"Link",isNotUsingObjectId:!0,initData:{count:0},methodConfig:{create:{valid:VALID(e)},update:!1,remove:!1}}}});OVERRIDE(KoreanURLShortener.LinkModel,t=>{KoreanURLShortener.LinkModel=OBJECT({preset:()=>{return t},init:(t,r,n)=>{var e=require("http"),o=require("https");process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",t.on("create",{before:function(t,n,s){var i=t.url,u=0,c=function(){var e;u<100&&(u+=1,e=String.fromCharCode(RANDOM({min:44032,max:55203}))+String.fromCharCode(RANDOM({min:44032,max:55203})),r.checkExists({filter:{id:e}},function(r){r===!0?c():(t.id=e,n())}))};return"http://"!==i.substring(0,7)&&"https://"!==i.substring(0,8)&&(t.url=i="http://"+i),r.get({filter:{url:i}},{success:function(t){s({savedData:t})},notExists:function(){("http://"===i.substring(0,7)?e:o).get(i,function(t){"http://짧.한국"===i.substring(0,11)||200!==t.statusCode&&301!==t.statusCode&&302!==t.statusCode?s({validErrors:{url:{type:"wrongURL"}}}):c()}).on("error",function(t){s({validErrors:{url:{type:"wrongURL"}}})})}}),!1}})}})}),KoreanURLShortener.MAIN=METHOD({run:function(t){"use strict";var r=require("child_process"),n=URI_MATCHER("{id}"),e=URI_MATCHER("__CAPTURE/{url}");t(function(t,o,s,i){var u,c,a=t.uri,h=n.check(a);if(h.checkIsMatched()===!0){try{KoreanURLShortener.LinkModel.update({id:decodeURIComponent(h.getURIParams().id),$inc:{count:1}},{notExists:function(){o({statusCode:302,headers:{Location:"http://"+encodeURIComponent("짧.한국")}})},success:function(t){o({statusCode:302,headers:{Location:t.url}})}})}catch(t){}return!1}return u=e.check(a),u.checkIsMatched()===!0?(c=u.getURIParams().url,c=c.substring(0,c.length-4),CHECK_FILE_EXISTS(NODE_CONFIG.rootPath+"/__CAPTURE/"+c+".png",function(t){var n;t===!0?(s(NODE_CONFIG.rootPath),i()):(n=r.spawn("phantomjs",["--ignore-ssl-errors=yes",NODE_CONFIG.rootPath+"/screencapture.js",c]),n.on("error",function(t){}),n.on("exit",function(){s(NODE_CONFIG.rootPath),i()}))}),!1):""!==a?(o({statusCode:302,headers:{Location:"http://"+encodeURIComponent("짧.한국")}}),!1):void 0})}});